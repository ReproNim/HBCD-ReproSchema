name: Convert HBCD Releases

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      release:
        description: 'HBCD Release Version (leave empty to auto-detect new versions)'
        required: false
        type: string
      create_tag:
        description: 'Create git tag for this release'
        type: boolean
        default: true
  # Automated trigger from NBDC release
  repository_dispatch:
    types: [nbdc-release]

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends cmake

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ~/R/library
          key: r-${{ runner.os }}-4.3-${{ hashFiles('.github/workflows/convert.yml') }}
          restore-keys: r-${{ runner.os }}-4.3-

      - name: Install R packages
        run: |
          mkdir -p ~/R/library
          Rscript -e '.libPaths("~/R/library"); install.packages("arrow", repos="https://cloud.r-project.org")'
          Rscript -e '.libPaths("~/R/library"); install.packages(c("tibble", "vctrs", "dplyr"), repos="https://cloud.r-project.org")'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install requests pyreadr
          pip install git+https://github.com/ReproNim/reproschema-py.git@1.1.0

      - name: Convert HBCD releases
        run: |
          python scripts/convert.py --release "${{ inputs.release }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          R_LIBS_USER: ~/R/library

      - name: Summary
        run: |
          echo "### Conversion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked for new HBCD versions and converted if found." >> $GITHUB_STEP_SUMMARY
